name: Salesforce Code Analyzer and PR Close

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:  
      # - name: Checkout Code  
      #   uses: actions/checkout@v4  

      # - name: Install Salesforce CLI  
      #   run: |
      #     npm install --global sfdx-cli
      #     export PATH=/usr/local/bin:$PATH  

      # - name: Install Salesforce Code Analyzer  
      #   run: sfdx plugins:install @salesforce/sfdx-scanner  

      # - name: Check Installed Plugins
      #   run: sf plugins

      # - name: Run Static Code Analysis  
      #   run: sf scanner run --format table --target force-app

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH  # Ensure CLI is in PATH

      - name: Verify Salesforce CLI Installation
        run: sf --version

      - name: Debug plugins
        run: sf plugins
      - name: Install Salesforce CLI
        run: |
          sf scanner run -t "./force-app/" -o "force-app-sf-code-analyser-result.csv" -f csv

  # close_pr:
    # if: failure()  # Этот шаг выполнится, если анализ не прошел
    # needs: analyze
    # runs-on: ubuntu-latest
    # steps:
    #   - name: Close Pull Request if analysis failed
    #     run: |
    #       echo "Closing PR due to failed analysis..."
    #       curl -X PATCH \
    #         -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
    #         -d '{"state": "closed"}' \
    #         "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}"
